---

export const prerender = true;

import fetchData from "../../../lib/fetchData";
import type FetchData from "../../../interfaces/FetchData";
import type BlogPage from "../../../interfaces/BlogPage";
import type BlogItem from "../../../interfaces/BlogItem";
import type CategoryItem from "../../../interfaces/CategoryItem";
import Layout from "../../../layouts/Layout.astro";
import BlogHeader from "../../../components/sections/blog/BlogHeader.tsx";
import BlogGrid from "../../../components/sections/blog/BlogGrid.tsx";
import BlogPagination from "../../../components/sections/blog/BlogPagination.tsx";
import Subscribe from "../../../components/sections/blog/Subscribe.tsx";

export async function getStaticPaths({ paginate }: any) {
  const queryCats = `
		query Query {
			catsModel {
				_id
				url
			}
		}
	`;

  const queryPosts = `
		query Query {
			blogModel {
				category
			}
		}
	`;

  const { catsModel }: FetchData = await fetchData(queryCats);
  const { blogModel }: FetchData = await fetchData(queryPosts);

  if ((catsModel && catsModel.length === 0) || (blogModel && blogModel.length === 0)) {
		return [];
  }

  return catsModel && catsModel.flatMap((cat) => {
    const filteredPosts = blogModel?.filter((item: BlogItem) => item.category._id === cat._id);
    return paginate(filteredPosts, {
      params: { category: cat.url },
      pageSize: 12,
    });
  });
}

const { page } = Astro.props as { page: BlogPage };

const query = `
query Query($filter: JsonType, $limit: Int, $skip: Int, $sort: JsonType) {
	blogModel(filter: $filter, limit: $limit, skip: $skip, sort: $sort) {
		_id
		_created
    title
    perex
		category
    image
		author {
			name
			title
			photo
		}
  }
	catsModel {
		_id
		title
		url
	}
}
`;

const variables = {
  filter: {
    "category._id": page.data[0].category._id,
  },
  limit: page.size,
  skip: page.start,
	sort: {
		_created: -1,
	},
};

const { blogModel: posts, catsModel: cats }: FetchData = await fetchData(query, variables);
---

<Layout title={`${cats?.find((cat) => cat._id === page.data[0].category._id)?.title} - Stranka ${page.currentPage} - Human Design`} description="">
	<BlogHeader />
	<BlogGrid posts={posts as BlogItem[]} cats={cats as CategoryItem[]} pageData={page} />
	<BlogPagination pageData={page} />
	<Subscribe />
</Layout>